#!/usr/bin/env bash

set -e

RUBY_INSTALL_VERSION="0.1.0"
SHARE_DIR="$(dirname $(dirname $0))/share/ruby-install"

source "$SHARE_DIR/functions.sh"
source "$SHARE_DIR/defaults.sh"

case "$1" in
	-h|--help)
		echo "usage: ruby-install RUBY [VERSION] -- CONFIGURE_OPTS"
		exit
		;;
	-v|--version)
		echo "ruby-install $RUBY_INSTALL_VERSION"
		exit
		;;
esac

RUBIES=(ruby jruby rubinius)

case $# in
	0)
		echo "Supported Rubies:"
		for ruby in ${RUBIES[@]}; do
			echo "  $ruby:"
			cat "$SHARE_DIR/$ruby/versions.txt" | sed -e 's/^/    /'
		done
		exit
		;;
	1)
		RUBY="$1"
		RUBY_VERSION="stable"
		;;
	2)
		RUBY="$1"
		RUBY_VERSION="$2"
		;;
esac

RUBY_DIR="$SHARE_DIR/$RUBY"

if [[ ! -d "$RUBY_DIR" ]]; then
	fail "ruby-install: unsupported ruby: $RUBY"
fi

RUBY_VERSION=$(fetch versions "$RUBY_VERSION" "$RUBY_VERSION")

source "$RUBY_DIR/functions.sh"

pre_install    || fail "Pre-install tasks failed!"
install_deps   || fail "Installing dependencies failed!"
download_ruby  || fail "Download of $RUBY_URL failed!"
verify_ruby    || fail "Verification of of $SRC_DIR/$RUBY_ARCHIVE failed!"
extract_ruby   || fail "Unpacking of $SRC_DIR/$RUBY_ARCHIVE failed!"
cd "$SRC_DIR/$RUBY_SRC_DIR"
apply_patches  || fail "Patching $SRC_DIR/$RUBY_SRC_DIR failed!"
configure_ruby || fail "Configuration of $SRC_DIR/$RUBY_SRC_DIR failed!"
compile_ruby   || fail "Compiling $SRC_DIR/$RUBY_SRC_DIR failed!"
install_ruby   || fail "Installation of $SRC_DIR/$RUBY_SRC_DIR failed!"
post_install   || fail "Post-install tasks failed!"

log "Successfully installed $RUBY $RUBY_VERSION into $INSTALL_DIR"
