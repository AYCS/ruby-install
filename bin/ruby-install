#!/usr/bin/env bash

set -e

SHARE_DIR="$(dirname $(dirname $0))/share/ruby-install"

source "$SHARE_DIR/ruby-install.sh"
source "$SHARE_DIR/variables.sh"

if [[ $# -eq 0 ]]; then
	supported_rubies
	exit
fi

parse_options $* || exit $?

RUBY_DIR="$SHARE_DIR/$RUBY"

if [[ ! -d "$RUBY_DIR" ]]; then
	echo "ruby-install: unsupported ruby: $RUBY" >&2
	exit -1
fi

RUBY_VERSION=$(fetch versions "$RUBY_VERSION" "$RUBY_VERSION")

source "$SHARE_DIR/functions.sh"
source "$RUBY_DIR/functions.sh"

auto_detect
pre_install    || fail "Pre-install tasks failed!"
install_deps   || fail "Installing dependencies failed!"
download_ruby  || fail "Download of $RUBY_URL failed!"
verify_ruby    || fail "Verification of of $SRC_DIR/$RUBY_ARCHIVE failed!"
extract_ruby   || fail "Unpacking of $SRC_DIR/$RUBY_ARCHIVE failed!"
cd "$SRC_DIR/$RUBY_SRC_DIR"
apply_patches  || fail "Patching $SRC_DIR/$RUBY_SRC_DIR failed!"
configure_ruby || fail "Configuration of $SRC_DIR/$RUBY_SRC_DIR failed!"
compile_ruby   || fail "Compiling $SRC_DIR/$RUBY_SRC_DIR failed!"
install_ruby   || fail "Installation of $SRC_DIR/$RUBY_SRC_DIR failed!"
post_install   || fail "Post-install tasks failed!"

log "Successfully installed $RUBY $RUBY_VERSION into $INSTALL_DIR"
